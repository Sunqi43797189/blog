---
title: MySQL行格式
date: 2020-05-26 20:36:27
tags:
---

### 行格式

- Compact

- Redundant

- Dynamic

- Compressed

### 指定行格式的语法

- 创建表时指定
  
  ```sql
  create table table_name (columns) row_format=行格式名称
  ```

- 修改表
  
  ```sql
  alter table table_name row_format=行格式名称
  ```

### Compact行格式

#### 变长字段长度列表

{% asset_img compact.png  image %}


- 一条完整的记录包括两个部分`记录的额外信息`和`记录的真实数据`

- 变长字段长度列表：表中变长字段长度占用的`字节数按照顺序逆序`排列

- 变长字段长度列表中只存储值为 ***非NULL*** 的列内容占用的长度，值为 ***NULL*** 的列的长度是不储存的

- 占用1个或2个字节，16进制表示

- 计算方式
  
  - W: 某个字符集中表示一个字符最多需要使用的字节数，比方说`utf8`字符集中的`W`就是`3`，`gbk`字符集中的`W`就是`2`，`ascii`字符集中的`W`就是`1`
  
  - M: 这种类型表示能存储最多的字符数，类型能表示的字符串最多占用的字节数就是`M×W`
  
  - L: 实际存储的字符串占用的字节数

- 判断方式
  
  - `M x W `< 255 1个字节
  
  - `M x W` > 255 
    
    - L <= 127 1个字节
    
    - L > 127 2个字节

- InnoDB在读记录的变长字段长度列表时先查看表结构，如果某个变长字段允许存储的最大字节数大于255时，区分它正在读的某个字节是一个单独的字段长度还是半个字段长度， 如果该字节的第一个位为0，那该字节就是一个单独的字段长度（使用一个字节表示不大于127的二进制的第一个位都为0），如果该字节的第一个位为1，那该字节就是半个字段长度。

- 对于 ***CHAR(M)*** 类型的列来说，当列采用的是定长字符集(ascii)时，该列占用的字节数不会被加到变长字段长度列表，而如果采用变长字符集(utf-8, gbk)时，该列占用的字节数也会被加到变长字段长度列表

#### NULL值列表

- 每个允许存储`NULL`的列对应一个二进制位，二进制位按照列的顺序逆序排列，二进制位按照列的顺序逆序排列，所以第一个null值的列与最后一个二进制位对应
  
  - 0：该列的值不是null
  
  - 1：该列的值是null

- `NULL值列表`必须用整数个字节的位表示，如果使用的二进制位个数不是整数个字节，则在字节的高位补`0`

- 在null值列表出现的列将不会出现在真实数据中，数据旧不会冗余

  {% asset_img null.png image %}


#### 记录头信息

- 固定的5个字节40个二进制位
  
  | 名称           | 大小  | 描述                                              |
  |:------------:|:---:|:-----------------------------------------------:|
  | 预留位1         | 1   | 未使用                                             |
  | 预留位2         | 1   | 未使用                                             |
  | delete_mask  | 1   | 标志记录是否被删除                                       |
  | min_rec_mask | 1   | B+树的每层非叶子节点中的最小记录都会添加该标记                        |
  | n_owned      | 4   | 表示当前记录拥有的记录数                                    |
  | heap_no      | 13  | 表示当前记录在记录堆的位置信息                                 |
  | record_type  | 3   | 表示当前记录的类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录 |
  | next_record  | 16  | 表示下一条记录的相对位置                                    |

#### 真实数据

- mysql添加隐藏列
  
  - DB_ROW_ID：行ID，唯一标识一条记录6个字节
  
  - DB_TRX_ID： 事务ID，6个字节
  
  - DB_ROLL_PTR：回滚指针，7个字节

- 优先使用用户自定义主键作为主键，如果用户没有定义主键，则选取一个`Unique`键作为主键，如果表中连`Unique`键都没有定义的话，则`InnoDB`会为表默认添加一个名为`db_row_id`的隐藏列作为主键
